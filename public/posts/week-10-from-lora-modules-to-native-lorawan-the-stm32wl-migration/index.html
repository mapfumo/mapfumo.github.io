<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>From LoRa Modules to Native LoRaWAN the STM32WL Migration - Wk10 | Antony Mapfumo</title>
<meta name="keywords" content="">
<meta name="description" content="The Challenge
For the first 9 weeks of this project, I&rsquo;ve been using RYLR998 LoRa modules - simple AT command modules that handled the radio work while my STM32 focused on sensors. They worked beautifully for point-to-point communication (600m range, 95% success rate), but they had a fundamental limitation:
They weren&rsquo;t LoRaWAN.
LoRa (the physical layer) is great for custom networks. But LoRaWAN (the MAC layer protocol) is what you need for:">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/week-10-from-lora-modules-to-native-lorawan-the-stm32wl-migration/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.2624896e1ea98c7b55634eefb2ccc9cd185a099a691a5f2ed998b2cc4e336532.css" integrity="sha256-JiSJbh6pjHtVY07vsszJzRhaCZppGl8u2ZiyzE4zZTI=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://localhost:1313/img/favicon.png">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/week-10-from-lora-modules-to-native-lorawan-the-stm32wl-migration/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Antony Mapfumo (Alt + H)">Antony Mapfumo</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/portfolio/" title="Portfolio">
                    <span>Portfolio</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tutorials/" title="Tutorials">
                    <span>Tutorials</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title">
      From LoRa Modules to Native LoRaWAN the STM32WL Migration - Wk10
    </h1>
    <div class="post-meta">Jan 11, 2026 · 10 min

</div>
  </header> 
<figure class="entry-cover"><a href="http://localhost:1313/img/wk10_image.svg" target="_blank"
            rel="noopener noreferrer"><img loading="lazy" src="http://localhost:1313/img/wk10_image.svg" alt="STM32F446RE NUCLEO board with SSD1306 OLED display"></a>
        <p>From LoRa Modules to Native LoRaWAN the STM32WL Migration</p>
</figure>
  <div class="post-content"><h2 id="the-challenge">The Challenge<a hidden class="anchor" aria-hidden="true" href="#the-challenge">#</a></h2>
<p>For the first 9 weeks of this project, I&rsquo;ve been using RYLR998 LoRa modules - simple AT command modules that handled the radio work while my STM32 focused on sensors. They worked beautifully for point-to-point communication (600m range, 95% success rate), but they had a fundamental limitation:</p>
<p><strong>They weren&rsquo;t LoRaWAN.</strong></p>
<p>LoRa (the physical layer) is great for custom networks. But <strong>LoRaWAN</strong> (the MAC layer protocol) is what you need for:</p>
<ul>
<li>Production deployments with network servers</li>
<li>Standards-compliant security (AES-128 encryption)</li>
<li>Multi-gateway coverage and roaming</li>
<li>Integration with The Things Network, ChirpStack, etc.</li>
<li>Commercial IoT platforms</li>
</ul>
<p>Week 10&rsquo;s goal: <strong>Migrate to production LoRaWAN using STM32WL&rsquo;s native SubGHz radio.</strong></p>
<hr>
<h2 id="what-changed">What Changed<a hidden class="anchor" aria-hidden="true" href="#what-changed">#</a></h2>
<h3 id="hardware-evolution">Hardware Evolution<a hidden class="anchor" aria-hidden="true" href="#hardware-evolution">#</a></h3>
<p><strong>Before (Weeks 1-9)</strong>:</p>
<pre tabindex="0"><code>STM32F446RE + RYLR998 Module
    ↓ UART AT commands
Point-to-point LoRa
</code></pre><p><strong>After (Week 10)</strong>:</p>
<pre tabindex="0"><code>STM32WL55JC (integrated SubGHz radio)
    ↓ Native SX126x driver
LoRaWAN with RAK7268V2 Gateway
    ↓ MQTT
InfluxDB + Grafana
</code></pre><h3 id="the-stm32wl55-advantage">The STM32WL55 Advantage<a hidden class="anchor" aria-hidden="true" href="#the-stm32wl55-advantage">#</a></h3>
<p>The STM32WL55JC is <strong>purpose-built for LoRaWAN</strong>:</p>
<table>
  <thead>
      <tr>
          <th>Feature</th>
          <th>STM32F446RE + RYLR998</th>
          <th>STM32WL55JC</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Radio</strong></td>
          <td>External module</td>
          <td>Integrated SubGHz transceiver</td>
      </tr>
      <tr>
          <td><strong>Interface</strong></td>
          <td>UART (AT commands)</td>
          <td>Direct SPI to radio peripheral</td>
      </tr>
      <tr>
          <td><strong>LoRaWAN Stack</strong></td>
          <td>None (custom protocol)</td>
          <td>Hardware-accelerated MAC</td>
      </tr>
      <tr>
          <td><strong>Cores</strong></td>
          <td>1 (Cortex-M4)</td>
          <td>2 (M4 + M0+ for radio)</td>
      </tr>
      <tr>
          <td><strong>BOM Cost</strong></td>
          <td>~$40</td>
          <td>~$25</td>
      </tr>
      <tr>
          <td><strong>Power</strong></td>
          <td>Higher (2 chips)</td>
          <td>Lower (single chip)</td>
      </tr>
  </tbody>
</table>
<p><strong>The dual-core architecture is clever</strong>: Cortex-M4 runs your application, Cortex-M0+ handles the radio stack. They communicate through shared memory.</p>
<hr>
<h2 id="the-system-architecture">The System Architecture<a hidden class="anchor" aria-hidden="true" href="#the-system-architecture">#</a></h2>
<h3 id="complete-2-node-lorawan-network">Complete 2-Node LoRaWAN Network<a hidden class="anchor" aria-hidden="true" href="#complete-2-node-lorawan-network">#</a></h3>
<p>I built two completely different nodes to showcase the flexibility:</p>
<p><strong>LoRa-1: Minimalist Temperature/Humidity Node</strong></p>
<ul>
<li>STM32WL55JC microcontroller</li>
<li>SHT41 high-precision sensor (±0.2°C, ±2% RH)</li>
<li>SSD1306 OLED 128x32 display</li>
<li><strong>4-byte payload</strong>: Just temperature and humidity</li>
<li>DevEUI: <code>23ce1bfeff091fac</code></li>
</ul>
<p><strong>LoRa-2: Full Environmental Monitoring Node</strong></p>
<ul>
<li>STM32WL55JC microcontroller</li>
<li>BME680 environmental sensor (temp, humidity, pressure, gas resistance)</li>
<li>SH1106 OLED 128x64 display (larger screen)</li>
<li><strong>12-byte payload</strong>: Full environmental data</li>
<li>DevEUI: <code>24ce1bfeff091fac</code></li>
</ul>
<p><strong>Gateway: RAK7268V2 WisGate Edge Lite 2</strong></p>
<ul>
<li>8-channel LoRaWAN concentrator</li>
<li>Built-in LoRa Server (not ChirpStack!)</li>
<li>MQTT broker for data export</li>
<li>AU915 Sub-band 2 (915.2-916.6 MHz)</li>
</ul>
<h3 id="data-pipeline">Data Pipeline<a hidden class="anchor" aria-hidden="true" href="#data-pipeline">#</a></h3>
<pre tabindex="0"><code>STM32WL Nodes
    ↓ LoRaWAN OTAA (AES-128 encrypted)
RAK Gateway (10.10.10.254)
    ↓ MQTT (application/TOT/device/+/rx)
Python Bridge (mqtt_to_influx.py)
    ↓ Decode Base64 payloads
InfluxDB (bucket: lorawan)
    ↓ Time-series storage
Grafana Dashboard (10 panels)
</code></pre><p><strong>End-to-end latency</strong>: &lt;2 seconds from sensor reading to dashboard update.</p>
<hr>
<h2 id="the-byte-order-gotcha-or-4-hours-of-my-life-ill-never-get-back">The Byte Order Gotcha (Or: 4 Hours of My Life I&rsquo;ll Never Get Back)<a hidden class="anchor" aria-hidden="true" href="#the-byte-order-gotcha-or-4-hours-of-my-life-ill-never-get-back">#</a></h2>
<h3 id="the-bug">The Bug<a hidden class="anchor" aria-hidden="true" href="#the-bug">#</a></h3>
<p>Day 3, everything compiles, firmware flashes, radio initializes&hellip; but join requests fail:</p>
<pre tabindex="0"><code>[INFO] Sending join request...
[INFO] Join attempt 1...
[INFO] Join attempt 2...
[INFO] Join attempt 3...
[ERROR] Join failed after 3 attempts
</code></pre><p>Gateway logs show:</p>
<pre tabindex="0"><code>nsParseJoinReq: unknow mote : ac1f09fffe1bce23
</code></pre><p><strong>Wait, what?</strong> My DevEUI is <code>23ce1bfeff091fac</code>, not <code>ac1f09fffe1bce23</code>!</p>
<p>Oh. <strong>Oh no.</strong></p>
<h3 id="the-root-cause">The Root Cause<a hidden class="anchor" aria-hidden="true" href="#the-root-cause">#</a></h3>
<p><strong>LoRaWAN byte order shenanigans.</strong></p>
<p>The LoRaWAN specification (§6.2.4) defines that EUIs are transmitted <strong>LSB-first</strong> (little-endian) over the air. But humans (and gateway UIs) display them <strong>MSB-first</strong> (big-endian) for readability.</p>
<p>The <code>lorawan-device</code> Rust crate follows the spec literally - it expects arrays in <strong>transmission order</strong> (little-endian).</p>
<p><strong>What I wrote</strong> (copying from gateway UI):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">DEV_EUI</span>: [<span style="color:#66d9ef">u8</span>; <span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x23</span>, <span style="color:#ae81ff">0xCE</span>, <span style="color:#ae81ff">0x1B</span>, <span style="color:#ae81ff">0xFE</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0x09</span>, <span style="color:#ae81ff">0x1F</span>, <span style="color:#ae81ff">0xAC</span>];
</span></span></code></pre></div><p><strong>What gets transmitted</strong>: Bytes in array order<br>
<strong>What gateway receives</strong>: LSB-first means <code>[0xAC, 0x1F, 0x09, ...]</code> → <code>ac1f09fffe1bce23</code><br>
<strong>What gateway expects</strong>: <code>23ce1bfeff091fac</code><br>
<strong>Result</strong>: &ldquo;unknow mote&rdquo; error</p>
<h3 id="the-fix">The Fix<a hidden class="anchor" aria-hidden="true" href="#the-fix">#</a></h3>
<p><strong>Reverse the byte order</strong> of DevEUI and AppEUI (but NOT AppKey):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// Gateway shows: 23ce1bfeff091fac
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Firmware needs: Reversed array for LSB-first transmission
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">DEV_EUI</span>: [<span style="color:#66d9ef">u8</span>; <span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0xAC</span>, <span style="color:#ae81ff">0x1F</span>, <span style="color:#ae81ff">0x09</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0xFE</span>, <span style="color:#ae81ff">0x1B</span>, <span style="color:#ae81ff">0xCE</span>, <span style="color:#ae81ff">0x23</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AppEUI: Also reversed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">APP_EUI</span>: [<span style="color:#66d9ef">u8</span>; <span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x56</span>, <span style="color:#ae81ff">0x53</span>, <span style="color:#ae81ff">0x29</span>, <span style="color:#ae81ff">0xC5</span>, <span style="color:#ae81ff">0x64</span>, <span style="color:#ae81ff">0xA8</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0xB1</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AppKey: Stays in big-endian (MSB first)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">APP_KEY</span>: [<span style="color:#66d9ef">u8</span>; <span style="color:#ae81ff">16</span>] <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0xB7</span>, <span style="color:#ae81ff">0x26</span>, <span style="color:#ae81ff">0x73</span>, <span style="color:#ae81ff">0x9B</span>, <span style="color:#ae81ff">0x78</span>, <span style="color:#ae81ff">0xEC</span>, <span style="color:#ae81ff">0x4B</span>, <span style="color:#ae81ff">0x9E</span>, <span style="color:#f92672">..</span>.];
</span></span></code></pre></div><p><strong>Result</strong>:</p>
<pre tabindex="0"><code>[INFO] Sending join request...
[INFO] Join succeeded! Session keys derived
[INFO] DevAddr: 010A5C3B
✓ JOINED
</code></pre><p><strong>Join time</strong>: ~7 seconds from power-on to first uplink.</p>
<h3 id="the-lesson">The Lesson<a hidden class="anchor" aria-hidden="true" href="#the-lesson">#</a></h3>
<blockquote>
<p><strong>When working with protocols that define byte order explicitly, always check if your library expects storage order or transmission order. They&rsquo;re often different.</strong></p>
</blockquote>
<p>This is a common embedded gotcha. I2C, SPI, CAN, Modbus - they all have byte order quirks. <strong>Working reference code is invaluable</strong> - I found a working STM32WL LoRaWAN example and compared byte-by-byte.</p>
<hr>
<h2 id="the-no-fpu-challenge">The No-FPU Challenge<a hidden class="anchor" aria-hidden="true" href="#the-no-fpu-challenge">#</a></h2>
<h3 id="the-problem">The Problem<a hidden class="anchor" aria-hidden="true" href="#the-problem">#</a></h3>
<p>STM32WL55 does <strong>NOT</strong> have a Floating Point Unit (FPU). Using <code>f32</code> or <code>f64</code> causes a <strong>HardFault</strong>.</p>
<p>But sensors return floating point values:</p>
<ul>
<li>SHT41: Temperature = -45 + (175 × raw) / 65535</li>
<li>BME680: Pressure in Pascals with fractional component</li>
</ul>
<h3 id="the-solution-integer-only-math">The Solution: Integer-Only Math<a hidden class="anchor" aria-hidden="true" href="#the-solution-integer-only-math">#</a></h3>
<p><strong>SHT41 conversion</strong> (temperature):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// ❌ WRONG - Uses FPU
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> temp_celsius: <span style="color:#66d9ef">f32</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">45.0</span> <span style="color:#f92672">+</span> (<span style="color:#ae81ff">175.0</span> <span style="color:#f92672">*</span> temp_raw <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">f32</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">65535.0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ✅ CORRECT - Integer-only
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> temp_celsius: <span style="color:#66d9ef">i16</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">45</span> <span style="color:#f92672">+</span> ((<span style="color:#ae81ff">175</span> <span style="color:#f92672">*</span> temp_raw <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">i32</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">65535</span>) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">i16</span>;
</span></span></code></pre></div><p><strong>For the payload, encode as fixed-point</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// Temperature: Store as centidegrees (27.6°C → 2760)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> temp_payload: <span style="color:#66d9ef">i16</span> <span style="color:#f92672">=</span> (temp_celsius <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">i16</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Humidity: Store as basis points (66.2% → 6620)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> hum_payload: <span style="color:#66d9ef">u16</span> <span style="color:#f92672">=</span> (hum_percent <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u16</span>;
</span></span></code></pre></div><p><strong>Payload structure</strong> (LoRa-1, 4 bytes):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    (temp_payload <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u8</span>,     <span style="color:#75715e">// Temperature high byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    temp_payload <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u8</span>,             <span style="color:#75715e">// Temperature low byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    (hum_payload <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u8</span>,      <span style="color:#75715e">// Humidity high byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    hum_payload <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u8</span>,              <span style="color:#75715e">// Humidity low byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>];
</span></span></code></pre></div><p><strong>Decoding in Python</strong> (MQTT bridge):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>temp_raw <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;h&#39;</span>, payload[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>])[<span style="color:#ae81ff">0</span>]  <span style="color:#75715e"># Signed 16-bit BE</span>
</span></span><span style="display:flex;"><span>hum_raw <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, payload[<span style="color:#ae81ff">2</span>:<span style="color:#ae81ff">4</span>])[<span style="color:#ae81ff">0</span>]   <span style="color:#75715e"># Unsigned 16-bit BE</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>temperature <span style="color:#f92672">=</span> temp_raw <span style="color:#f92672">/</span> <span style="color:#ae81ff">100.0</span>  <span style="color:#75715e"># Centidegrees to Celsius</span>
</span></span><span style="display:flex;"><span>humidity <span style="color:#f92672">=</span> hum_raw <span style="color:#f92672">/</span> <span style="color:#ae81ff">100.0</span>       <span style="color:#75715e"># Basis points to percent</span>
</span></span></code></pre></div><h3 id="why-this-matters">Why This Matters<a hidden class="anchor" aria-hidden="true" href="#why-this-matters">#</a></h3>
<p><strong>Efficiency</strong>: Integer math is <strong>significantly faster</strong> on Cortex-M4 without FPU:</p>
<ul>
<li>FPU emulation: ~100+ cycles per operation</li>
<li>Native integer: 1-4 cycles per operation</li>
</ul>
<p><strong>Correctness</strong>: No FPU means no floating point - attempts to use FPU instructions cause HardFault.</p>
<hr>
<h2 id="the-mqtt-bridge-to-influxdb">The MQTT Bridge to InfluxDB<a hidden class="anchor" aria-hidden="true" href="#the-mqtt-bridge-to-influxdb">#</a></h2>
<h3 id="gateway-mqtt-structure">Gateway MQTT Structure<a hidden class="anchor" aria-hidden="true" href="#gateway-mqtt-structure">#</a></h3>
<p>RAK7268V2 publishes to MQTT with this structure:</p>
<p><strong>Topic</strong>: <code>application/TOT/device/{DevEUI}/rx</code></p>
<p><strong>Payload</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;applicationID&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;devEUI&#34;</span>: <span style="color:#e6db74">&#34;23ce1bfeff091fac&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;fPort&#34;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;data&#34;</span>: <span style="color:#e6db74">&#34;CowZyA==&#34;</span>, <span style="color:#75715e">// Base64-encoded LoRaWAN payload
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">&#34;rxInfo&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;rssi&#34;</span>: <span style="color:#ae81ff">-17</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;loRaSNR&#34;</span>: <span style="color:#ae81ff">11.5</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;txInfo&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;frequency&#34;</span>: <span style="color:#ae81ff">916600000</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;dr&#34;</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="python-bridge-mqtt_to_influxpy">Python Bridge (mqtt_to_influx.py)<a hidden class="anchor" aria-hidden="true" href="#python-bridge-mqtt_to_influxpy">#</a></h3>
<p>The bridge:</p>
<ol>
<li>Subscribes to <code>application/TOT/device/+/rx</code></li>
<li>Decodes Base64 payload</li>
<li>Auto-detects format (4 bytes = LoRa-1, 12 bytes = LoRa-2)</li>
<li>Writes to InfluxDB with tags</li>
</ol>
<p><strong>Key code</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode_payload</span>(data_b64, dev_eui):
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(data_b64)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(payload) <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>:  <span style="color:#75715e"># LoRa-1: SHT41</span>
</span></span><span style="display:flex;"><span>        temp <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;h&#39;</span>, payload[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>])[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">/</span> <span style="color:#ae81ff">100.0</span>
</span></span><span style="display:flex;"><span>        hum <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, payload[<span style="color:#ae81ff">2</span>:<span style="color:#ae81ff">4</span>])[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">/</span> <span style="color:#ae81ff">100.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;temp&#39;</span>: temp, <span style="color:#e6db74">&#39;hum&#39;</span>: hum}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> len(payload) <span style="color:#f92672">==</span> <span style="color:#ae81ff">12</span>:  <span style="color:#75715e"># LoRa-2: BME680</span>
</span></span><span style="display:flex;"><span>        temp <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;h&#39;</span>, payload[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>])[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">/</span> <span style="color:#ae81ff">100.0</span>
</span></span><span style="display:flex;"><span>        hum <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, payload[<span style="color:#ae81ff">2</span>:<span style="color:#ae81ff">4</span>])[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">/</span> <span style="color:#ae81ff">100.0</span>
</span></span><span style="display:flex;"><span>        press <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, payload[<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">6</span>])[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">/</span> <span style="color:#ae81ff">10.0</span>
</span></span><span style="display:flex;"><span>        gas <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, payload[<span style="color:#ae81ff">6</span>:<span style="color:#ae81ff">8</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;temp&#39;</span>: temp, <span style="color:#e6db74">&#39;hum&#39;</span>: hum, <span style="color:#e6db74">&#39;press&#39;</span>: press, <span style="color:#e6db74">&#39;gas&#39;</span>: gas}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_to_influxdb</span>(data, dev_eui, rssi, snr):
</span></span><span style="display:flex;"><span>    point <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;measurement&#34;</span>: <span style="color:#e6db74">&#34;lorawan_sensor&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;tags&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;node&#34;</span>: <span style="color:#e6db74">&#34;lora1&#34;</span> <span style="color:#66d9ef">if</span> dev_eui <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;23ce1b...&#34;</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;lora2&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;dev_eui&#34;</span>: dev_eui
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;fields&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;temperature&#34;</span>: data[<span style="color:#e6db74">&#39;temp&#39;</span>],
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;humidity&#34;</span>: data[<span style="color:#e6db74">&#39;hum&#39;</span>],
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;rssi&#34;</span>: rssi,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;snr&#34;</span>: snr
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    influx_client<span style="color:#f92672">.</span>write(bucket<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;lorawan&#34;</span>, record<span style="color:#f92672">=</span>point)
</span></span></code></pre></div><p><strong>Docker deployment</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mqtt-bridge</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>: <span style="color:#ae81ff">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">wk10-mqtt-bridge</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">network_mode</span>: <span style="color:#ae81ff">host</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">GATEWAY_MQTT_HOST=10.10.10.254</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">INFLUXDB_HOST=localhost</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">unless-stopped</span>
</span></span></code></pre></div><hr>
<h2 id="the-grafana-dashboard">The Grafana Dashboard<a hidden class="anchor" aria-hidden="true" href="#the-grafana-dashboard">#</a></h2>
<h3 id="10-panel-visualization">10-Panel Visualization<a hidden class="anchor" aria-hidden="true" href="#10-panel-visualization">#</a></h3>
<p><strong>Dashboard</strong>: LoRaWAN Sensor Network</p>
<p><strong>Panels</strong>:</p>
<ol>
<li><strong>Temperature Comparison</strong> (time series) - Both nodes</li>
<li><strong>Humidity Comparison</strong> (time series) - Both nodes</li>
<li><strong>Pressure</strong> (time series) - LoRa-2 only</li>
<li><strong>Gas Resistance</strong> (time series) - LoRa-2 only</li>
<li><strong>RSSI</strong> (time series) - Signal strength</li>
<li><strong>SNR</strong> (time series) - Signal quality
7-10. <strong>Stat panels</strong> - Latest values with thresholds</li>
</ol>
<p><strong>Flux query example</strong> (temperature comparison):</p>
<pre tabindex="0"><code class="language-flux" data-lang="flux">from(bucket: &#34;lorawan&#34;)
  |&gt; range(start: -1h)
  |&gt; filter(fn: (r) =&gt; r._measurement == &#34;lorawan_sensor&#34;)
  |&gt; filter(fn: (r) =&gt; r._field == &#34;temperature&#34;)
  |&gt; filter(fn: (r) =&gt; r.node == &#34;lora1&#34; or r.node == &#34;lora2&#34;)
</code></pre><p><strong>Live data update</strong>: 10-second auto-refresh</p>
<hr>
<h2 id="results-whats-working-right-now">Results: What&rsquo;s Working Right Now<a hidden class="anchor" aria-hidden="true" href="#results-whats-working-right-now">#</a></h2>
<h3 id="performance-metrics">Performance Metrics<a hidden class="anchor" aria-hidden="true" href="#performance-metrics">#</a></h3>
<table>
  <thead>
      <tr>
          <th>Metric</th>
          <th>Value</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Join Time</strong></td>
          <td>~7 seconds (OTAA)</td>
      </tr>
      <tr>
          <td><strong>Uplink Interval</strong></td>
          <td>~30 seconds</td>
      </tr>
      <tr>
          <td><strong>LoRa-1 Payload</strong></td>
          <td>4 bytes</td>
      </tr>
      <tr>
          <td><strong>LoRa-2 Payload</strong></td>
          <td>12 bytes</td>
      </tr>
      <tr>
          <td><strong>Air Time</strong></td>
          <td>~1.3-1.5 seconds</td>
      </tr>
      <tr>
          <td><strong>End-to-End Latency</strong></td>
          <td>&lt;2 seconds</td>
      </tr>
      <tr>
          <td><strong>Typical RSSI</strong></td>
          <td>-15 to -80 dBm</td>
      </tr>
      <tr>
          <td><strong>Typical SNR</strong></td>
          <td>10-14 dB</td>
      </tr>
  </tbody>
</table>
<h3 id="live-readings-indoor-5m-from-gateway">Live Readings (Indoor, ~5m from gateway)<a hidden class="anchor" aria-hidden="true" href="#live-readings-indoor-5m-from-gateway">#</a></h3>
<p><strong>LoRa-1</strong> (SHT41):</p>
<ul>
<li>Temperature: 31°C</li>
<li>Humidity: 58% RH</li>
<li>RSSI: -13 dBm</li>
<li>SNR: 13.2 dB</li>
</ul>
<p><strong>LoRa-2</strong> (BME680):</p>
<ul>
<li>Temperature: 28°C</li>
<li>Humidity: 60% RH</li>
<li>Pressure: 1020 hPa</li>
<li>Gas Resistance: 135 kOhm</li>
<li>RSSI: -17 dBm</li>
<li>SNR: 12.0 dB</li>
</ul>
<h3 id="system-stability">System Stability<a hidden class="anchor" aria-hidden="true" href="#system-stability">#</a></h3>
<ul>
<li>✅ Both nodes joining successfully</li>
<li>✅ Continuous uplinks (no missed packets)</li>
<li>✅ MQTT bridge running stable (24+ hours)</li>
<li>✅ Grafana dashboard live-updating</li>
<li>✅ Zero crashes or reconnects</li>
</ul>
<hr>
<h2 id="key-technical-achievements">Key Technical Achievements<a hidden class="anchor" aria-hidden="true" href="#key-technical-achievements">#</a></h2>
<h3 id="1-native-lorawan-stack">1. Native LoRaWAN Stack<a hidden class="anchor" aria-hidden="true" href="#1-native-lorawan-stack">#</a></h3>
<p>Not using an external module - <strong>direct control</strong> of the SubGHz radio peripheral:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// Initialize SX126x radio (integrated in STM32WL)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> radio <span style="color:#f92672">=</span> Sx126x::new(
</span></span><span style="display:flex;"><span>    spi,               <span style="color:#75715e">// SubGHz SPI
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    iv,                <span style="color:#75715e">// Interface variant (RF switch control)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    config,            <span style="color:#75715e">// Radio config
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> delay
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Create LoRaWAN device
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> device <span style="color:#f92672">=</span> Device::new(
</span></span><span style="display:flex;"><span>    region::Configuration::new(<span style="color:#66d9ef">AU915</span>::default()),
</span></span><span style="display:flex;"><span>    radio,
</span></span><span style="display:flex;"><span>    EmbassyTimer::new(),
</span></span><span style="display:flex;"><span>    rng
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// OTAA join
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> join_mode <span style="color:#f92672">=</span> JoinMode::<span style="color:#66d9ef">OTAA</span> {
</span></span><span style="display:flex;"><span>    deveui: <span style="color:#a6e22e">DevEui</span>::from(<span style="color:#66d9ef">DEV_EUI</span>),
</span></span><span style="display:flex;"><span>    appeui: <span style="color:#a6e22e">AppEui</span>::from(<span style="color:#66d9ef">APP_EUI</span>),
</span></span><span style="display:flex;"><span>    appkey: <span style="color:#a6e22e">AppKey</span>::from(<span style="color:#66d9ef">APP_KEY</span>),
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p><strong>Embassy async/await</strong> makes the state machine elegant:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">loop</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Send uplink
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    device.send(<span style="color:#f92672">&amp;</span>payload, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">false</span>).<span style="color:#66d9ef">await</span>.ok();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Wait for next transmission
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Timer::after_secs(<span style="color:#ae81ff">30</span>).<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2-i2c-peripheral-sharing-again">2. I2C Peripheral Sharing (Again!)<a hidden class="anchor" aria-hidden="true" href="#2-i2c-peripheral-sharing-again">#</a></h3>
<p>Same pattern as Week 9 - share I2C between sensor and display:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">loop</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Read sensor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> i2c <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { I2c::new_blocking(<span style="color:#66d9ef">I2C2</span>::steal(), <span style="color:#f92672">..</span>.) };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> (temp, hum) <span style="color:#f92672">=</span> read_sht41(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> i2c).<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Update display
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> display <span style="color:#f92672">=</span> Ssd1306::new(I2CDisplayInterface::new(i2c), <span style="color:#f92672">..</span>.);
</span></span><span style="display:flex;"><span>    display.draw(<span style="color:#f92672">..</span>.);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Timer::after_secs(<span style="color:#ae81ff">2</span>).<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Why safe</strong>: Sequential access, peripherals dropped before next iteration.</p>
<h3 id="3-oled-real-time-status">3. OLED Real-Time Status<a hidden class="anchor" aria-hidden="true" href="#3-oled-real-time-status">#</a></h3>
<p><strong>LoRa-1 Display</strong> (128x32, 2 lines):</p>
<pre tabindex="0"><code>LoRa-1 TX:42
31C 57%  R-13 S13
</code></pre><p><strong>LoRa-2 Display</strong> (128x64, 6 lines):</p>
<pre tabindex="0"><code>LoRa-2 TX:28
T 28C  H 60%
P 1020hPa
Gas 135kOhm
R -17 S 12
JOINED
</code></pre><p><strong>Why this matters</strong>: No probe-rs needed for debugging. Physical status visible on desk.</p>
<hr>
<h2 id="challenges-overcome">Challenges Overcome<a hidden class="anchor" aria-hidden="true" href="#challenges-overcome">#</a></h2>
<h3 id="1-lorawan-byte-order">1. LoRaWAN Byte Order<a hidden class="anchor" aria-hidden="true" href="#1-lorawan-byte-order">#</a></h3>
<p><strong>Solution</strong>: Reverse EUI arrays for LSB-first transmission</p>
<h3 id="2-no-fpu">2. No FPU<a hidden class="anchor" aria-hidden="true" href="#2-no-fpu">#</a></h3>
<p><strong>Solution</strong>: Integer-only math, fixed-point encoding</p>
<h3 id="3-sht41-wake-up">3. SHT41 Wake-Up<a hidden class="anchor" aria-hidden="true" href="#3-sht41-wake-up">#</a></h3>
<p><strong>Problem</strong>: Sensor doesn&rsquo;t respond to I2C scan initially<br>
<strong>Solution</strong>: Send measurement command (0xFD) before scanning</p>
<h3 id="4-mqtt-protocol-version">4. MQTT Protocol Version<a hidden class="anchor" aria-hidden="true" href="#4-mqtt-protocol-version">#</a></h3>
<p><strong>Problem</strong>: RAK gateway uses MQTT 3.1 (older version)<br>
<strong>Solution</strong>: Use paho-mqtt library (handles negotiation automatically)</p>
<h3 id="5-rf-switch-control">5. RF Switch Control<a hidden class="anchor" aria-hidden="true" href="#5-rf-switch-control">#</a></h3>
<p><strong>Problem</strong>: NUCLEO-WL55JC1 needs GPIO control for antenna routing<br>
<strong>Solution</strong>: Custom <code>iv.rs</code> module implementing <code>InterfaceVariant</code> trait</p>
<hr>
<h2 id="what-i-learned">What I Learned<a hidden class="anchor" aria-hidden="true" href="#what-i-learned">#</a></h2>
<h3 id="technical-lessons">Technical Lessons<a hidden class="anchor" aria-hidden="true" href="#technical-lessons">#</a></h3>
<ol>
<li><strong>LoRaWAN byte order is mandatory</strong> - No shortcuts, reverse those EUIs</li>
<li><strong>No FPU = No problem</strong> - Integer math is faster anyway</li>
<li><strong>Embassy async is perfect</strong> - LoRaWAN state machine maps naturally to async/await</li>
<li><strong>Working examples save hours</strong> - Found reference code, compared line-by-line</li>
<li><strong>MQTT is flexible</strong> - Protocol version negotiation handled by good libraries</li>
</ol>
<h3 id="meta-lessons">Meta-Lessons<a hidden class="anchor" aria-hidden="true" href="#meta-lessons">#</a></h3>
<ol>
<li><strong>Baby steps still work</strong> - One node first, extract common code after</li>
<li><strong>Hardware differences matter</strong> - Different displays required different drivers</li>
<li><strong>Documentation pays off</strong> - Comprehensive USERGUIDE.md made deployment trivial</li>
<li><strong>Real-world testing essential</strong> - Integer math bugs only show up with actual sensor values</li>
</ol>
<hr>
<h2 id="next-week-security-week-11">Next Week: Security (Week 11)<a hidden class="anchor" aria-hidden="true" href="#next-week-security-week-11">#</a></h2>
<p>Week 10 completes the LoRaWAN migration. Week 11 shifts to <strong>security hardening</strong>:</p>
<ul>
<li>STRIDE threat modeling</li>
<li>TLS for MQTT/OPC-UA</li>
<li>Authentication frameworks</li>
<li>Security best practices documentation</li>
</ul>
<p><strong>The goal</strong>: Make this system <strong>production-ready</strong> from a security perspective.</p>
<hr>
<h2 id="try-it-yourself">Try It Yourself<a hidden class="anchor" aria-hidden="true" href="#try-it-yourself">#</a></h2>
<h3 id="hardware-needed-200">Hardware Needed (~$200)<a hidden class="anchor" aria-hidden="true" href="#hardware-needed-200">#</a></h3>
<ul>
<li>2x NUCLEO-WL55JC1 boards (~$25 each)</li>
<li>RAK7268V2 LoRaWAN gateway (~$120)</li>
<li>SHT41 sensor (~$8)</li>
<li>BME680 sensor (~$15)</li>
<li>2x OLED displays (~$5 each)</li>
<li>Breadboards and jumpers (~$15)</li>
</ul>
<h3 id="quick-start">Quick Start<a hidden class="anchor" aria-hidden="true" href="#quick-start">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Clone repo</span>
</span></span><span style="display:flex;"><span>git clone https://github.com/mapfumo/wk10-lorawan
</span></span><span style="display:flex;"><span>cd wk10-lorawan
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Flash LoRa-1</span>
</span></span><span style="display:flex;"><span>cd firmware/lora-1
</span></span><span style="display:flex;"><span>cargo run --release
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Flash LoRa-2</span>
</span></span><span style="display:flex;"><span>cd firmware/lora-2
</span></span><span style="display:flex;"><span>cargo run --release
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Start data pipeline</span>
</span></span><span style="display:flex;"><span>docker compose up -d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Open Grafana dashboard</span>
</span></span><span style="display:flex;"><span>http://localhost:3000
</span></span></code></pre></div><p><strong>Expected result</strong>: Both nodes join within 10 seconds, data flowing to Grafana within 1 minute.</p>
<hr>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>Week 10 was about <strong>production readiness</strong>:</p>
<ul>
<li>✅ Standards-compliant LoRaWAN (not custom protocol)</li>
<li>✅ Native radio integration (no external modules)</li>
<li>✅ Complete data pipeline (sensors → gateway → database → dashboard)</li>
<li>✅ Two different nodes (showcasing flexibility)</li>
<li>✅ Real-time visualization (10 Grafana panels)</li>
</ul>
<p><strong>The system is now</strong>:</p>
<ul>
<li>Scalable (add more nodes easily)</li>
<li>Secure (AES-128 encryption, OTAA key derivation)</li>
<li>Observable (comprehensive metrics)</li>
<li>Maintainable (well-documented)</li>
</ul>
<p><strong>But most importantly</strong>: It&rsquo;s <strong>working</strong>. Right now. On my desk. Uplinks every 30 seconds, dashboard updating in real-time, zero errors.</p>
<p>From Week 1&rsquo;s LED blink to Week 10&rsquo;s production LoRaWAN network - <strong>every step built on the last</strong>. Baby steps work.</p>
<hr>
<h2 id="resources">Resources<a hidden class="anchor" aria-hidden="true" href="#resources">#</a></h2>
<h3 id="code">Code<a hidden class="anchor" aria-hidden="true" href="#code">#</a></h3>
<ul>
<li><a href="https://github.com/mapfumo/wk10-lorawan">Week 10 Repository</a></li>
</ul>
<h3 id="documentation">Documentation<a hidden class="anchor" aria-hidden="true" href="#documentation">#</a></h3>
<ul>
<li><a href="https://lora-alliance.org/resource_hub/lorawan-specification-v1-0-4/">LoRaWAN Specification</a></li>
<li><a href="https://www.st.com/resource/en/reference_manual/rm0453-stm32wl5x-advanced-armbased-32bit-mcus-with-subghz-radio-solution-stmicroelectronics.pdf">STM32WL Reference Manual</a></li>
<li><a href="https://docs.rs/lora-phy/">lora-phy Documentation</a></li>
<li><a href="https://docs.rs/lorawan-device/">lorawan-device Documentation</a></li>
</ul>
<h3 id="previous-weeks">Previous Weeks<a hidden class="anchor" aria-hidden="true" href="#previous-weeks">#</a></h3>
<ul>
<li><a href="https://github.com/mapfumo/wk9-opcua-modbus">Week 9: Modbus TCP + OPC-UA</a></li>
<li><a href="https://github.com/mapfumo/wk7-mqtt-influx">Week 7+8: MQTT + InfluxDB + Grafana</a></li>
</ul>
<hr>
<p><strong>Author</strong>: Antony (Tony) Mapfumo<br>
<strong>Part of</strong>: 12-Week IIoT Systems Engineer Transition<br>
<strong>Week</strong>: 10 of 12 (83% complete)<br>
<strong>Status</strong>: ✅ LoRaWAN Migration Complete</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="http://localhost:1313/posts/modbus-opcua-week-9/">
    <span class="title">Next »</span>
    <br>
    <span>From IoT to Industrial Automation: Modbus TCP and OPC UA [Open Platform Communications Unified Architecture] - Wk9</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share From LoRa Modules to Native LoRaWAN the STM32WL Migration - Wk10 on twitter"
        href="https://twitter.com/intent/tweet/?text=From%20LoRa%20Modules%20to%20Native%20LoRaWAN%20the%20STM32WL%20Migration%20-%20Wk10&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fweek-10-from-lora-modules-to-native-lorawan-the-stm32wl-migration%2f&amp;hashtags=">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share From LoRa Modules to Native LoRaWAN the STM32WL Migration - Wk10 on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fweek-10-from-lora-modules-to-native-lorawan-the-stm32wl-migration%2f&amp;title=From%20LoRa%20Modules%20to%20Native%20LoRaWAN%20the%20STM32WL%20Migration%20-%20Wk10&amp;summary=From%20LoRa%20Modules%20to%20Native%20LoRaWAN%20the%20STM32WL%20Migration%20-%20Wk10&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fweek-10-from-lora-modules-to-native-lorawan-the-stm32wl-migration%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share From LoRa Modules to Native LoRaWAN the STM32WL Migration - Wk10 on reddit"
        href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fweek-10-from-lora-modules-to-native-lorawan-the-stm32wl-migration%2f&title=From%20LoRa%20Modules%20to%20Native%20LoRaWAN%20the%20STM32WL%20Migration%20-%20Wk10">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share From LoRa Modules to Native LoRaWAN the STM32WL Migration - Wk10 on facebook"
        href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fweek-10-from-lora-modules-to-native-lorawan-the-stm32wl-migration%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share From LoRa Modules to Native LoRaWAN the STM32WL Migration - Wk10 on whatsapp"
        href="https://api.whatsapp.com/send?text=From%20LoRa%20Modules%20to%20Native%20LoRaWAN%20the%20STM32WL%20Migration%20-%20Wk10%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fweek-10-from-lora-modules-to-native-lorawan-the-stm32wl-migration%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
   
</div>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2026 <a href="http://localhost:1313/">Antony Mapfumo</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
